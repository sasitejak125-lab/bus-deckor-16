<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bus Decker</title>

<link rel="stylesheet" href="styles.css">
</head>

<body>

<header>
  <h1>üöå Bus Decker</h1>
  <span id="liveStatus">‚óè Offline</span>
</header>

<!-- ASSIGN -->
<section class="card">
  <h3>Assign Person</h3>
  <input id="nameInput" placeholder="Name">
  <select id="busSelect">
    <option value="">Select Bus</option>
    <option value="1">Bus 1</option>
    <option value="2">Bus 2</option>
    <option value="3">Bus 3</option>
    <option value="4">Bus 4</option>
    <option value="5">Bus 5</option>
  </select>
  <button onclick="assign()">Assign</button>
</section>

<!-- UNASSIGN -->
<section class="card">
  <h3>Unassign Person</h3>
  <input id="unassignInput" placeholder="Name">
  <button class="danger" onclick="unassign()">Unassign</button>
</section>

<!-- ADD NEW -->
<section class="card">
  <h3>Add New Person</h3>
  <input id="newName" placeholder="Name">
  <input id="newMobile" placeholder="Mobile">
  <button onclick="addPerson()">Add Person</button>
</section>

<!-- SUMMARY -->
<section class="card">
  <h3>Summary</h3>
  <div>Total People: <strong id="total">0</strong></div>
  <div>Assigned: <strong id="assigned">0</strong></div>
</section>

<!-- BUS LIST -->
<section id="busList"></section>

<script>
/* ================= CONFIG ================= */
const API_URL =
  "https://script.google.com/macros/s/AKfycbzOwfnrdkY5_T6fPg4JYKpVi8YkZsts_Te_S0FyiKAsI1sJpiePh1JpDxXLJIS0fdnk5w/exec";

/* ================= STATE ================= */
let lastUpdatedAt = "";

/* ================= LOAD DATA ================= */
async function loadData() {
  try {
    const res = await fetch(API_URL);
    const json = await res.json();

    if (lastUpdatedAt && lastUpdatedAt !== json.updatedAt) {
      showLiveUpdate();
    }

    lastUpdatedAt = json.updatedAt;
    render(json.data);

    setOnline();
  } catch (e) {
    setOffline();
    console.error("Load failed", e);
  }
}

/* ================= LIVE STATUS ================= */
function showLiveUpdate() {
  const s = document.getElementById("liveStatus");
  s.textContent = "‚óè Live update";
  s.className = "live";
  setTimeout(() => {
    s.textContent = "‚óè Online";
    s.className = "online";
  }, 2000);
}

function setOnline() {
  const s = document.getElementById("liveStatus");
  s.textContent = "‚óè Online";
  s.className = "online";
}

function setOffline() {
  const s = document.getElementById("liveStatus");
  s.textContent = "‚óè Offline";
  s.className = "offline";
}

/* ================= RENDER ================= */
function render(data) {
  document.getElementById("total").textContent = data.length;
  document.getElementById("assigned").textContent =
    data.filter(p => p.Bus).length;

  const buses = {};
  data.forEach(p => {
    const key = p.Bus ? `Bus ${p.Bus}` : "Unassigned";
    buses[key] ??= [];
    buses[key].push(p.Name);
  });

  const busList = document.getElementById("busList");
  busList.innerHTML = "";

  Object.keys(buses).forEach(bus => {
    busList.innerHTML += `
      <div class="bus">
        <strong>${bus} (${buses[bus].length})</strong>
        ${buses[bus].map(n => `<div>${n}</div>`).join("")}
      </div>
    `;
  });
}

/* ================= ACTIONS ================= */
function assign() {
  const name = nameInput.value.trim();
  const bus = busSelect.value;

  if (!name || !bus) {
    alert("Enter name and bus");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "assign",
      name,
      bus
    })
  }).then(() => {
    nameInput.value = "";
    busSelect.value = "";
    loadData();
  });
}

function unassign() {
  const name = unassignInput.value.trim();
  if (!name) {
    alert("Enter name");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "unassign",
      name
    })
  }).then(() => {
    unassignInput.value = "";
    loadData();
  });
}

function addPerson() {
  const name = newName.value.trim();
  const mobile = newMobile.value.trim();

  if (!name) {
    alert("Name required");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "add",
      name,
      mobile
    })
  }).then(() => {
    newName.value = "";
    newMobile.value = "";
    loadData();
  });
}

/* ================= INIT ================= */
loadData();
setInterval(loadData, 5000); // live refresh every 5s
</script>

</body>
</html>

