<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bus Decker</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>

<header>
  <h1>üöå Bus Decker</h1>
  <span id="liveStatus" class="offline">‚óè Offline</span>
</header>

<section class="card">
  <h3>Assign Person</h3>

  <div class="input-group">
    <input id="nameInput" placeholder="Search name">
    <div id="assignSuggestions" class="suggestion-box"></div>
  </div>

  <select id="busSelect">
    <option value="">Select Bus</option>
    <option value="1">Bus 1</option>
    <option value="2">Bus 2</option>
    <option value="3">Bus 3</option>
    <option value="4">Bus 4</option>
    <option value="5">Bus 5</option>
  </select>

  <button onclick="assign()">Assign</button>
</section>

<section class="card">
  <h3>Unassign Person</h3>

  <div class="input-group">
    <input id="unassignInput" placeholder="Search assigned">
    <div id="unassignSuggestions" class="suggestion-box"></div>
  </div>

  <button class="danger" onclick="unassign()">Unassign</button>
</section>

<section class="card">
  <h3>Add New Person</h3>
  <input id="newName" placeholder="Name">
  <input id="newMobile" placeholder="Mobile">
  <button onclick="addPerson()">Add Person</button>
</section>

<section class="card">
  <h3>Summary</h3>
  <div>Total People: <strong id="total">0</strong></div>
  <div>Assigned: <strong id="assigned">0</strong></div>
</section>

<section id="busList"></section>

<script>
/* ================= CONFIG ================= */
const API =
  "https://script.google.com/macros/s/AKfycbzOwfnrdkY5_T6fPg4JYKpVi8YkZsts_Te_S0FyiKAsI1sJpiePh1JpDxXLJIS0fdnk5w/exec";

/* ================= STATE ================= */
let people = [];

/* ================= LOAD ================= */
async function loadData() {
  try {
    const res = await fetch(API);
    const json = await res.json();

    people = Array.isArray(json.data) ? json.data : [];
    render();

    liveStatus.textContent = "‚óè Online";
    liveStatus.className = "online";
  } catch (e) {
    console.error("Load failed:", e);
    liveStatus.textContent = "‚óè Offline";
    liveStatus.className = "offline";
  }
}

/* ================= AUTOCOMPLETE ================= */
function autocomplete(input, box, filterFn, selectFn) {
  input.addEventListener("input", () => {
    const q = input.value.toLowerCase();
    box.innerHTML = "";

    if (!q) {
      box.style.display = "none";
      return;
    }

    const matches = people.filter(p =>
      p.Name && filterFn(p, q)
    );

    if (!matches.length) {
      box.style.display = "none";
      return;
    }

    matches.slice(0, 15).forEach(p => {
      const div = document.createElement("div");
      div.textContent = p.Name + (p.Bus ? ` (Bus ${p.Bus})` : "");
      div.onclick = () => {
        selectFn(p);
        box.style.display = "none";
      };
      box.appendChild(div);
    });

    box.style.display = "block";
  });
}

autocomplete(
  nameInput,
  assignSuggestions,
  (p, q) => p.Name.toLowerCase().includes(q),
  p => {
    nameInput.value = p.Name;
    busSelect.value = p.Bus || "";
  }
);

autocomplete(
  unassignInput,
  unassignSuggestions,
  (p, q) => p.Bus && p.Name.toLowerCase().includes(q),
  p => unassignInput.value = p.Name
);

document.addEventListener("click", e => {
  if (!e.target.closest(".input-group")) {
    assignSuggestions.style.display = "none";
    unassignSuggestions.style.display = "none";
  }
});

/* ================= RENDER ================= */
function render() {
  total.textContent = people.length;
  assigned.textContent = people.filter(p => p.Bus).length;

  const map = {};
  people.forEach(p => {
    const k = p.Bus ? `Bus ${p.Bus}` : "Unassigned";
    map[k] ??= [];
    map[k].push(p.Name);
  });

  busList.innerHTML = "";
  Object.keys(map).forEach(b => {
    busList.innerHTML += `
      <div class="bus">
        <strong>${b} (${map[b].length})</strong>
        ${map[b].map(n => `<div>${n}</div>`).join("")}
      </div>
    `;
  });
}

/* ================= ACTIONS (GET ONLY) ================= */
function assign() {
  fetch(`${API}?action=assign&name=${encodeURIComponent(nameInput.value)}&bus=${busSelect.value}`)
    .then(loadData);
}

function unassign() {
  fetch(`${API}?action=unassign&name=${encodeURIComponent(unassignInput.value)}`)
    .then(loadData);
}

function addPerson() {
  fetch(`${API}?action=add&name=${encodeURIComponent(newName.value)}&mobile=${encodeURIComponent(newMobile.value)}`)
    .then(() => {
      newName.value = "";
      newMobile.value = "";
      loadData();
    });
}

/* ================= INIT ================= */
loadData();
setInterval(loadData, 5000);
</script>

</body>
</html>
