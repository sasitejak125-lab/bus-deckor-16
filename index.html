<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bus Decker</title>

<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<header>
  <h1>üöå Bus Decker</h1>
  <span id="liveStatus" class="offline">‚óè Offline</span>
</header>

<!-- ASSIGN -->
<section class="card">
  <h3>Assign Person</h3>
  <div class="input-group">
    <input id="nameInput" placeholder="Search name" autocomplete="off">
    <div id="assignSuggestions" class="suggestion-box"></div>
  </div>

  <select id="busSelect">
    <option value="">Select Bus</option>
    <option value="1">Bus 1</option>
    <option value="2">Bus 2</option>
    <option value="3">Bus 3</option>
    <option value="4">Bus 4</option>
    <option value="5">Bus 5</option>
  </select>

  <button onclick="assign()">Assign</button>
</section>

<!-- UNASSIGN -->
<section class="card">
  <h3>Unassign Person</h3>
  <div class="input-group">
    <input id="unassignInput" placeholder="Search assigned" autocomplete="off">
    <div id="unassignSuggestions" class="suggestion-box"></div>
  </div>
  <button class="danger" onclick="unassign()">Unassign</button>
</section>

<!-- ADD -->
<section class="card">
  <h3>Add New Person</h3>
  <input id="newName" placeholder="Name">
  <input id="newMobile" placeholder="Mobile">
  <button onclick="addPerson()">Add Person</button>
</section>

<!-- SUMMARY -->
<section class="card">
  <h3>Summary</h3>
  <div>Total: <strong id="total">0</strong></div>
  <div>Assigned: <strong id="assigned">0</strong></div>
  <div>Unassigned: <strong id="unassigned">0</strong></div>

  <canvas id="pieChart"></canvas>
</section>

<!-- BUS LIST -->
<section id="busList"></section>

<script>
/* ================= CONFIG ================= */
const API =
  "https://script.google.com/macros/s/AKfycbzOwfnrdkY5_T6fPg4JYKpVi8YkZsts_Te_S0FyiKAsI1sJpiePh1JpDxXLJIS0fdnk5w/exec";

/* ================= STATE ================= */
let people = [];
let pieChart = null;

/* ================= LOAD DATA ================= */
async function loadData() {
  try {
    const r = await fetch(API);
    const j = await r.json();

    people = Array.isArray(j.data) ? j.data : [];
    renderAll();

    liveStatus.textContent = "‚óè Online";
    liveStatus.className = "online";
  } catch (e) {
    console.error(e);
    liveStatus.textContent = "‚óè Offline";
    liveStatus.className = "offline";
  }
}

/* ================= AUTOCOMPLETE (BOUND ONCE) ================= */
function bindAutocomplete(input, box, filterFn, selectFn) {
  input.addEventListener("input", () => {
    const q = input.value.trim().toLowerCase();
    box.innerHTML = "";

    if (!q) return box.style.display = "none";

    const matches = people.filter(
      p => p.Name && filterFn(p) && p.Name.toLowerCase().includes(q)
    );

    if (!matches.length) return box.style.display = "none";

    matches.slice(0, 15).forEach(p => {
      const d = document.createElement("div");
      d.innerHTML = highlight(p.Name, q);
      d.onclick = () => {
        selectFn(p);
        box.style.display = "none";
      };
      box.appendChild(d);
    });

    box.style.display = "block";
  });
}

function highlight(text, q) {
  const i = text.toLowerCase().indexOf(q);
  if (i < 0) return text;
  return `${text.slice(0,i)}<mark>${text.slice(i,i+q.length)}</mark>${text.slice(i+q.length)}`;
}

/* Bind once */
bindAutocomplete(nameInput, assignSuggestions, () => true, p => {
  nameInput.value = p.Name;
  busSelect.value = p.Bus || "";
});

bindAutocomplete(unassignInput, unassignSuggestions, p => p.Bus, p => {
  unassignInput.value = p.Name;
});

/* ================= RENDER ALL ================= */
function renderAll() {
  renderSummary();
  renderPie();
  renderBusList();
}

/* SUMMARY */
function renderSummary() {
  const totalCount = people.length;
  const assignedCount = people.filter(p => p.Bus).length;

  total.textContent = totalCount;
  assigned.textContent = assignedCount;
  unassigned.textContent = totalCount - assignedCount;
}

/* PIE */
function renderPie() {
  const counts = {
    unassigned: people.filter(p => !p.Bus).length,
    1: 0, 2: 0, 3: 0, 4: 0, 5: 0
  };

  people.forEach(p => {
    if (counts[p.Bus] !== undefined) counts[p.Bus]++;
  });

  const data = [
    counts.unassigned,
    counts[1], counts[2], counts[3], counts[4], counts[5]
  ];

  if (!pieChart) {
    pieChart = new Chart(pieChartEl, {
      type: "pie",
      data: {
        labels: ["Unassigned","Bus 1","Bus 2","Bus 3","Bus 4","Bus 5"],
        datasets: [{
          data,
          backgroundColor: [
            "#9ca3af","#2563eb","#16a34a","#f59e0b","#7c3aed","#dc2626"
          ]
        }]
      },
      options: { plugins:{ legend:{ position:"bottom" } } }
    });
  } else {
    pieChart.data.datasets[0].data = data;
    pieChart.update();
  }
}

/* BUS LIST */
function renderBusList() {
  const map = {};
  people.forEach(p => {
    const k = p.Bus ? `Bus ${p.Bus}` : "Unassigned";
    map[k] ??= [];
    map[k].push(p.Name);
  });

  busList.innerHTML = "";
  Object.keys(map).forEach(k => {
    busList.innerHTML += `
      <div class="bus">
        <strong>${k} (${map[k].length})</strong>
        ${map[k].map(n => `<div>${n}</div>`).join("")}
      </div>
    `;
  });
}

/* ================= ACTIONS ================= */
function assign() {
  fetch(`${API}?action=assign&name=${encodeURIComponent(nameInput.value)}&bus=${busSelect.value}`)
    .then(loadData);
}

function unassign() {
  fetch(`${API}?action=unassign&name=${encodeURIComponent(unassignInput.value)}`)
    .then(loadData);
}

function addPerson() {
  fetch(`${API}?action=add&name=${encodeURIComponent(newName.value)}&mobile=${encodeURIComponent(newMobile.value)}`)
    .then(loadData);
}

/* ================= INIT ================= */
const pieChartEl = document.getElementById("pieChart");
loadData();
setInterval(loadData, 5000);
</script>

</body>
</html>
