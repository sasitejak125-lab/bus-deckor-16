<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bus Decker</title>

<link rel="stylesheet" href="styles.css">
</head>

<body>

<header>
  <h1>üöå Bus Decker</h1>
  <span id="liveStatus" class="offline">‚óè Offline</span>
</header>

<!-- ASSIGN -->
<section class="card">
  <h3>Assign Person</h3>

  <div class="input-group">
    <input id="nameInput" placeholder="Search name">
    <div id="assignSuggestions" class="suggestion-box"></div>
  </div>

  <select id="busSelect">
    <option value="">Select Bus</option>
    <option value="1">Bus 1</option>
    <option value="2">Bus 2</option>
    <option value="3">Bus 3</option>
    <option value="4">Bus 4</option>
    <option value="5">Bus 5</option>
  </select>

  <button onclick="assign()">Assign</button>
</section>

<!-- UNASSIGN -->
<section class="card">
  <h3>Unassign Person</h3>

  <div class="input-group">
    <input id="unassignInput" placeholder="Search assigned">
    <div id="unassignSuggestions" class="suggestion-box"></div>
  </div>

  <button class="danger" onclick="unassign()">Unassign</button>
</section>

<!-- ADD NEW -->
<section class="card">
  <h3>Add New Person</h3>
  <input id="newName" placeholder="Name">
  <input id="newMobile" placeholder="Mobile">
  <button onclick="addPerson()">Add Person</button>
</section>

<!-- SUMMARY -->
<section class="card">
  <h3>Summary</h3>
  <div>Total People: <strong id="total">0</strong></div>
  <div>Assigned: <strong id="assigned">0</strong></div>
</section>

<!-- BUS LIST -->
<section id="busList"></section>

<script>
/* ================= CONFIG ================= */
const API_URL =
  "https://script.google.com/macros/s/AKfycbzOwfnrdkY5_T6fPg4JYKpVi8YkZsts_Te_S0FyiKAsI1sJpiePh1JpDxXLJIS0fdnk5w/exec";

/* ================= STATE ================= */
let people = [];
let lastUpdatedAt = "";

/* ================= LOAD DATA ================= */
async function loadData() {
  try {
    const res = await fetch(API_URL);
    const json = await res.json();

    if (lastUpdatedAt && lastUpdatedAt !== json.updatedAt) {
      showLiveUpdate();
    }

    lastUpdatedAt = json.updatedAt;
    people = json.data;

    render();
    setOnline();
  } catch (e) {
    console.error("Fetch failed:", e);
    setOffline();
  }
}

/* ================= STATUS ================= */
function setOnline() {
  liveStatus.textContent = "‚óè Online";
  liveStatus.className = "online";
}

function setOffline() {
  liveStatus.textContent = "‚óè Offline";
  liveStatus.className = "offline";
}

function showLiveUpdate() {
  liveStatus.textContent = "‚óè Live update";
  liveStatus.className = "live";
  setTimeout(setOnline, 2000);
}

/* ================= AUTOCOMPLETE ================= */
function setupAutocomplete(input, box, filterFn, onSelect) {
  input.addEventListener("input", () => {
    const q = input.value.trim().toLowerCase();
    box.innerHTML = "";

    if (!q) {
      box.style.display = "none";
      return;
    }

    const matches = people.filter(filterFn(q));
    if (!matches.length) {
      box.style.display = "none";
      return;
    }

    matches.slice(0, 15).forEach(p => {
      const div = document.createElement("div");
      div.textContent = p.Name + (p.Bus ? ` (Bus ${p.Bus})` : "");
      div.onclick = () => {
        onSelect(p);
        box.style.display = "none";
      };
      box.appendChild(div);
    });

    box.style.display = "block";
  });
}

/* Assign autocomplete */
setupAutocomplete(
  nameInput,
  assignSuggestions,
  q => p => p.Name.toLowerCase().includes(q),
  p => {
    nameInput.value = p.Name;
    busSelect.value = p.Bus || "";
  }
);

/* Unassign autocomplete */
setupAutocomplete(
  unassignInput,
  unassignSuggestions,
  q => p => p.Bus && p.Name.toLowerCase().includes(q),
  p => {
    unassignInput.value = p.Name;
  }
);

/* Hide suggestions on outside click */
document.addEventListener("click", e => {
  if (!e.target.closest(".input-group")) {
    assignSuggestions.style.display = "none";
    unassignSuggestions.style.display = "none";
  }
});

/* ================= RENDER ================= */
function render() {
  total.textContent = people.length;
  assigned.textContent = people.filter(p => p.Bus).length;

  const buses = {};
  people.forEach(p => {
    const key = p.Bus ? `Bus ${p.Bus}` : "Unassigned";
    buses[key] ??= [];
    buses[key].push(p.Name);
  });

  busList.innerHTML = "";
  Object.keys(buses).forEach(bus => {
    busList.innerHTML += `
      <div class="bus">
        <strong>${bus} (${buses[bus].length})</strong>
        ${buses[bus].map(n => `<div>${n}</div>`).join("")}
      </div>
    `;
  });
}

/* ================= ACTIONS ================= */
function assign() {
  if (!nameInput.value || !busSelect.value) {
    alert("Select name and bus");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "assign",
      name: nameInput.value,
      bus: busSelect.value
    })
  }).then(() => {
    nameInput.value = "";
    busSelect.value = "";
    loadData();
  });
}

function unassign() {
  if (!unassignInput.value) {
    alert("Select name");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "unassign",
      name: unassignInput.value
    })
  }).then(() => {
    unassignInput.value = "";
    loadData();
  });
}

function addPerson() {
  if (!newName.value) {
    alert("Name required");
    return;
  }

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "add",
      name: newName.value,
      mobile: newMobile.value
    })
  }).then(() => {
    newName.value = "";
    newMobile.value = "";
    loadData();
  });
}

/* ================= INIT ================= */
loadData();
setInterval(loadData, 5000);
</script>

</body>
</html>
