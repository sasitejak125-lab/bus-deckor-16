<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Team Outing Bus Decker</title>

  <link rel="stylesheet" href="styles.css"/>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<header>
  <h1>Team Outing Bus Decker</h1>
  <h2>Smart Assignment Dashboard · 16/12/2025</h2>
</header>

<!-- Upload -->
<div class="card controls-container">
  <button id="uploadBtn" class="primary">Upload CSV / XLSX</button>
  <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" hidden />
  <span id="fileName">No file selected</span>
  <button id="downloadCsv" disabled>Download CSV</button>
  <button id="downloadXlsx" disabled>Download XLSX</button>
</div>

<!-- Assign -->
<div class="card">
  <h3>Assign Person</h3>
  <div class="controls-container">
    <div class="input-group">
      <label>Name</label>
      <input id="nameInput" type="text" placeholder="Start typing..." autocomplete="off"/>
      <div id="suggestions" class="suggestion-box"></div>
    </div>

    <div>
      <label>Bus</label>
      <select id="busSelect">
        <option value="">Select</option>
        <option value="1">Bus 1</option>
        <option value="2">Bus 2</option>
        <option value="3">Bus 3</option>
        <option value="4">Bus 4</option>
        <option value="5">Bus 5</option>
      </select>
    </div>

    <button id="submitBtn" class="success">Assign</button>
    <span id="tick">✔</span>
  </div>
</div>

<!-- Unassign -->
<div class="card">
  <h3>Unassign Person</h3>
  <div class="controls-container">
    <div class="input-group">
      <label>Name</label>
      <input id="unassignNameInput" type="text" placeholder="Search assigned person..." autocomplete="off"/>
      <div id="unassignSuggestions" class="suggestion-box"></div>
    </div>

    <div>
      <label>Current Bus</label>
      <input id="currentBus" type="text" disabled />
    </div>

    <button id="unassignBtn" class="danger">Unassign</button>
  </div>
</div>

<!-- Summary -->
<div class="card">
  <h3>Overall Status</h3>

  <div class="summary">
    <div class="metric">
      <span class="value" id="totalCount">0</span>
      <span class="label">Total</span>
    </div>
    <div class="metric">
      <span class="value" id="assignedCount">0</span>
      <span class="label">Assigned</span>
    </div>
    <div class="metric">
      <span class="value" id="unassignedCount">0</span>
      <span class="label">Unassigned</span>
    </div>

    <canvas id="pieChart" width="120" height="120"></canvas>
  </div>
</div>

<!-- Bus Grid -->
<div class="card">
  <h3>Bus Assignments</h3>
  <div id="busSummaryContainer" class="bus-grid"></div>
</div>

<script>
let people = [];
let pieChart;

/* Elements */
const uploadBtn = document.getElementById('uploadBtn');
const fileInput = document.getElementById('fileInput');
const fileName = document.getElementById('fileName');
const nameInput = document.getElementById('nameInput');
const busSelect = document.getElementById('busSelect');
const submitBtn = document.getElementById('submitBtn');
const tick = document.getElementById('tick');
const suggestions = document.getElementById('suggestions');

const unassignNameInput = document.getElementById('unassignNameInput');
const unassignSuggestions = document.getElementById('unassignSuggestions');
const currentBus = document.getElementById('currentBus');
const unassignBtn = document.getElementById('unassignBtn');

const totalCount = document.getElementById('totalCount');
const assignedCount = document.getElementById('assignedCount');
const unassignedCount = document.getElementById('unassignedCount');
const busSummaryContainer = document.getElementById('busSummaryContainer');
const pieCanvas = document.getElementById('pieChart');

/* Counter animation */
function animate(el, value) {
  const start = Number(el.textContent);
  const duration = 500;
  const t0 = performance.now();

  function step(t) {
    const p = Math.min((t - t0) / duration, 1);
    el.textContent = Math.floor(start + (value - start) * p);
    if (p < 1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* Upload */
uploadBtn.onclick = () => fileInput.click();
fileInput.onchange = async e => {
  const f = e.target.files[0];
  if (!f) return;
  fileName.textContent = f.name;

  if (f.name.endsWith('.csv')) {
    const txt = await f.text();
    people = txt.trim().split('\n').slice(1).map(l => {
      const [Name, Mobile, Bus] = l.split(',');
      return { Name, Mobile, Bus };
    });
  } else {
    const buf = await f.arrayBuffer();
    const wb = XLSX.read(buf, { type:'array' });
    people = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
  }
  render();
};

/* Assign autocomplete */
nameInput.oninput = () => {
  const q = nameInput.value.toLowerCase();
  suggestions.innerHTML = '';
  if (!q) return suggestions.style.display = 'none';

  people.filter(p => p.Name.toLowerCase().includes(q))
    .slice(0,10)
    .forEach(p => {
      const d = document.createElement('div');
      d.textContent = p.Name;
      d.onclick = () => {
        nameInput.value = p.Name;
        busSelect.value = p.Bus || '';
        suggestions.style.display = 'none';
      };
      suggestions.appendChild(d);
    });
  suggestions.style.display = 'block';
};

/* Assign */
submitBtn.onclick = () => {
  const p = people.find(x => x.Name.toLowerCase() === nameInput.value.toLowerCase());
  if (!p || !busSelect.value) return alert('Invalid input');
  p.Bus = busSelect.value;
  tick.style.display = 'inline';
  setTimeout(()=>tick.style.display='none',800);
  nameInput.value=''; busSelect.value='';
  render();
};

/* Unassign autocomplete */
unassignNameInput.oninput = () => {
  const q = unassignNameInput.value.toLowerCase();
  unassignSuggestions.innerHTML='';
  currentBus.value='';

  if (!q) return unassignSuggestions.style.display='none';

  people.filter(p => p.Bus && p.Name.toLowerCase().includes(q))
    .slice(0,10)
    .forEach(p=>{
      const d=document.createElement('div');
      d.textContent=`${p.Name} (Bus ${p.Bus})`;
      d.onclick=()=>{
        unassignNameInput.value=p.Name;
        currentBus.value=`Bus ${p.Bus}`;
        unassignSuggestions.style.display='none';
      };
      unassignSuggestions.appendChild(d);
    });
  unassignSuggestions.style.display='block';
};

/* Unassign */
unassignBtn.onclick = () => {
  const p = people.find(x => x.Name.toLowerCase() === unassignNameInput.value.toLowerCase());
  if (!p || !p.Bus) return alert('Not assigned');
  p.Bus='';
  unassignNameInput.value='';
  currentBus.value='';
  render();
};

/* Render */
function render() {
  const buses={0:[],1:[],2:[],3:[],4:[],5:[]};
  people.forEach(p => buses[p.Bus||0].push(p));

  animate(totalCount, people.length);
  animate(assignedCount, people.filter(p=>p.Bus).length);
  animate(unassignedCount, buses[0].length);

  if (pieChart) pieChart.destroy();
  pieChart = new Chart(pieCanvas,{
    type:'pie',
    data:{
      labels:['U','1','2','3','4','5'],
      datasets:[{data:[buses[0].length,buses[1].length,buses[2].length,buses[3].length,buses[4].length,buses[5].length],
      backgroundColor:['#9ca3af','#2563eb','#16a34a','#f59e0b','#7c3aed','#dc2626']}]
    },
    options:{responsive:false,plugins:{legend:{display:false}}}
  });

  busSummaryContainer.innerHTML='';
  [1,2,3,4,5].forEach(i=>{
    busSummaryContainer.innerHTML+=`
      <div class="bus bus${i}">
        <div class="bus-head">Bus ${i}<span>${buses[i].length}</span></div>
        ${buses[i].map(p=>`<div>${p.Name}</div>`).join('')}
      </div>`;
  });
}
render();
</script>
</body>
</html>
