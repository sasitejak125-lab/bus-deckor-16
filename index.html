<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Bus Decker</title>

<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<header>
  <h1>üöå Bus Decker</h1>
  <span id="liveStatus" class="offline">‚óè Offline</span>
</header>

<!-- ASSIGN -->
<section class="card">
  <h3>Assign Person</h3>

  <div class="input-group">
    <input id="nameInput" placeholder="Search name">
    <div id="assignSuggestions" class="suggestion-box"></div>
  </div>

  <select id="busSelect">
    <option value="">Select Bus</option>
    <option value="1">Bus 1</option>
    <option value="2">Bus 2</option>
    <option value="3">Bus 3</option>
    <option value="4">Bus 4</option>
    <option value="5">Bus 5</option>
  </select>

  <button onclick="assign()">Assign</button>
</section>

<!-- UNASSIGN -->
<section class="card">
  <h3>Unassign Person</h3>

  <div class="input-group">
    <input id="unassignInput" placeholder="Search assigned">
    <div id="unassignSuggestions" class="suggestion-box"></div>
  </div>

  <button class="danger" onclick="unassign()">Unassign</button>
</section>

<!-- ADD -->
<section class="card">
  <h3>Add New Person</h3>
  <input id="newName" placeholder="Name">
  <input id="newMobile" placeholder="Mobile">
  <button onclick="addPerson()">Add Person</button>
</section>

<!-- SUMMARY -->
<section class="card">
  <h3>Summary</h3>
  <div>Total People: <strong id="total">0</strong></div>
  <div>Assigned: <strong id="assigned">0</strong></div>
  <div>Unassigned: <strong id="unassigned">0</strong></div>

  <div class="bus-summary">
    <div>Bus 1: <strong id="b1">0</strong></div>
    <div>Bus 2: <strong id="b2">0</strong></div>
    <div>Bus 3: <strong id="b3">0</strong></div>
    <div>Bus 4: <strong id="b4">0</strong></div>
    <div>Bus 5: <strong id="b5">0</strong></div>
  </div>

  <canvas id="pieChart"></canvas>
</section>

<!-- BUS LIST -->
<section id="busList"></section>

<script>
/* ================= CONFIG ================= */
const API =
  "https://script.google.com/macros/s/AKfycbzOwfnrdkY5_T6fPg4JYKpVi8YkZsts_Te_S0FyiKAsI1sJpiePh1JpDxXLJIS0fdnk5w/exec";

/* ================= STATE ================= */
let people = [];
let pieChart = null;

/* ================= LOAD ================= */
async function loadData() {
  try {
    const res = await fetch(API);
    const json = await res.json();

    people = Array.isArray(json.data) ? json.data : [];
    render();
    setupAutocompletes();

    liveStatus.textContent = "‚óè Online";
    liveStatus.className = "online";
  } catch (e) {
    console.error(e);
    liveStatus.textContent = "‚óè Offline";
    liveStatus.className = "offline";
  }
}

/* ================= AUTOCOMPLETE ================= */
function setupAutocompletes() {
  setupAutocomplete(
    nameInput,
    assignSuggestions,
    p => true,
    p => {
      nameInput.value = p.Name;
      busSelect.value = p.Bus || "";
    }
  );

  setupAutocomplete(
    unassignInput,
    unassignSuggestions,
    p => p.Bus,
    p => unassignInput.value = p.Name
  );
}

function setupAutocomplete(input, box, conditionFn, selectFn) {
  input.oninput = () => {
    const q = input.value.toLowerCase();
    box.innerHTML = "";

    if (!q) {
      box.style.display = "none";
      return;
    }

    const matches = people.filter(
      p => p.Name && conditionFn(p) && p.Name.toLowerCase().includes(q)
    );

    if (!matches.length) {
      box.style.display = "none";
      return;
    }

    matches.slice(0, 15).forEach(p => {
      const div = document.createElement("div");
      div.innerHTML = highlightMatch(p.Name, q) +
        (p.Bus ? ` <span class="bus-tag">Bus ${p.Bus}</span>` : "");
      div.onclick = () => {
        selectFn(p);
        box.style.display = "none";
      };
      box.appendChild(div);
    });

    box.style.display = "block";
  };
}

function highlightMatch(text, q) {
  const i = text.toLowerCase().indexOf(q);
  if (i === -1) return text;
  return (
    text.slice(0, i) +
    "<mark>" +
    text.slice(i, i + q.length) +
    "</mark>" +
    text.slice(i + q.length)
  );
}

document.addEventListener("click", e => {
  if (!e.target.closest(".input-group")) {
    assignSuggestions.style.display = "none";
    unassignSuggestions.style.display = "none";
  }
});

/* ================= RENDER ================= */
function render() {
  const totalPeople = people.length;
  const assignedPeople = people.filter(p => p.Bus).length;

  total.textContent = totalPeople;
  assigned.textContent = assignedPeople;
  unassigned.textContent = totalPeople - assignedPeople;

  const busCounts = {1:0,2:0,3:0,4:0,5:0};
  people.forEach(p => {
    if (busCounts[p.Bus]) busCounts[p.Bus]++;
  });

  b1.textContent = busCounts[1];
  b2.textContent = busCounts[2];
  b3.textContent = busCounts[3];
  b4.textContent = busCounts[4];
  b5.textContent = busCounts[5];

  renderPie(busCounts, totalPeople - assignedPeople);
  renderBusList(busCounts);
}

function renderBusList() {
  const map = {};
  people.forEach(p => {
    const k = p.Bus ? `Bus ${p.Bus}` : "Unassigned";
    map[k] ??= [];
    map[k].push(p.Name);
  });

  busList.innerHTML = "";
  Object.keys(map).forEach(b => {
    busList.innerHTML += `
      <div class="bus">
        <strong>${b} (${map[b].length})</strong>
        ${map[b].map(n => `<div>${n}</div>`).join("")}
      </div>
    `;
  });
}

/* ================= PIE CHART ================= */
function renderPie(busCounts, unassignedCount) {
  const data = [
    unassignedCount,
    busCounts[1],
    busCounts[2],
    busCounts[3],
    busCounts[4],
    busCounts[5]
  ];

  if (!pieChart) {
    pieChart = new Chart(pieChartEl, {
      type: "pie",
      data: {
        labels: ["Unassigned","Bus 1","Bus 2","Bus 3","Bus 4","Bus 5"],
        datasets: [{
          data,
          backgroundColor: [
            "#9ca3af","#2563eb","#16a34a","#f59e0b","#7c3aed","#dc2626"
          ]
        }]
      },
      options: {
        plugins: { legend: { position: "bottom" } }
      }
    });
  } else {
    pieChart.data.datasets[0].data = data;
    pieChart.update();
  }
}

/* ================= ACTIONS ================= */
function assign() {
  fetch(`${API}?action=assign&name=${encodeURIComponent(nameInput.value)}&bus=${busSelect.value}`)
    .then(loadData);
}

function unassign() {
  fetch(`${API}?action=unassign&name=${encodeURIComponent(unassignInput.value)}`)
    .then(loadData);
}

function addPerson() {
  fetch(`${API}?action=add&name=${encodeURIComponent(newName.value)}&mobile=${encodeURIComponent(newMobile.value)}`)
    .then(() => {
      newName.value = "";
      newMobile.value = "";
      loadData();
    });
}

/* ================= INIT ================= */
const pieChartEl = document.getElementById("pieChart");
loadData();
setInterval(loadData, 5000);
</script>

</body>
</html>
